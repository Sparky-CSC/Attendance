import React, { useState, useEffect } from 'react';
import { Clock, Users, Settings, QrCode, Hash, Download, Trash2, Plus, Calendar, X } from 'lucide-react';

const AttendanceTracker = () => {
  const [view, setView] = useState('student');
  const [instructorView, setInstructorView] = useState('dashboard');
  const [instructorAuthenticated, setInstructorAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');
  
  const [classes, setClasses] = useState([]);
  const [selectedClass, setSelectedClass] = useState(null);
  const [sessions, setSessions] = useState([]);
  const [currentSession, setCurrentSession] = useState(null);
  const [currentCode, setCurrentCode] = useState('');
  const [qrDataUrl, setQrDataUrl] = useState('');
  const [timeRemaining, setTimeRemaining] = useState(0);
  
  const [settings, setSettings] = useState({
    presentUntil: 5,
    tardyUntil: 15,
    codeRefreshInterval: 2
  });
  
  const [attendance, setAttendance] = useState([]);
  const [studentCode, setStudentCode] = useState('');
  const [studentName, setStudentName] = useState('');
  const [checkInMessage, setCheckInMessage] = useState('');
  
  const [newClassName, setNewClassName] = useState('');
  const [newSessionDate, setNewSessionDate] = useState('');
  const [newSessionTime, setNewSessionTime] = useState('');
  const [newSessionName, setNewSessionName] = useState('');

  const handleInstructorLogin = () => {
    if (password === 'instructor123') {
      setInstructorAuthenticated(true);
      setLoginError('');
    } else {
      setLoginError('Incorrect password');
      setTimeout(() => setLoginError(''), 3000);
    }
  };

  const generateCode = () => {
    return Math.floor(100000 + Math.random() * 900000).toString();
  };

  const generateQRCode = (code) => {
    const size = 200;
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');
    
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = '#000000';
    const gridSize = 8;
    const cellSize = size / gridSize;
    
    let seed = parseInt(code);
    for (let i = 0; i < gridSize; i++) {
      for (let j = 0; j < gridSize; j++) {
        seed = (seed * 9301 + 49297) % 233280;
        if (seed / 233280 > 0.5) {
          ctx.fillRect(j * cellSize, i * cellSize, cellSize, cellSize);
        }
      }
    }
    
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(size/4, size/4, size/2, size/2);
    ctx.fillStyle = '#000000';
    ctx.font = 'bold 24px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(code, size/2, size/2);
    
    return canvas.toDataURL();
  };

  const addClass = () => {
    if (!newClassName.trim()) {
      alert('Please enter a class name');
      return;
    }
    const newClass = {
      id: Date.now(),
      name: newClassName,
      createdAt: new Date().toISOString()
    };
    setClasses([...classes, newClass]);
    setNewClassName('');
  };

  const deleteClass = (classId) => {
    if (window.confirm('Delete this class and all its sessions?')) {
      setClasses(classes.filter(c => c.id !== classId));
      setSessions(sessions.filter(s => s.classId !== classId));
      setAttendance(attendance.filter(a => a.classId !== classId));
    }
  };

  const addSession = () => {
    if (!selectedClass) {
      alert('Please select a class first');
      return;
    }
    if (!newSessionDate || !newSessionTime) {
      alert('Please enter date and time');
      return;
    }
    const newSession = {
      id: Date.now(),
      classId: selectedClass.id,
      className: selectedClass.name,
      date: newSessionDate,
      time: newSessionTime,
      name: newSessionName || 'Session',
      status: 'scheduled',
      createdAt: new Date().toISOString()
    };
    setSessions([...sessions, newSession]);
    setNewSessionDate('');
    setNewSessionTime('');
    setNewSessionName('');
  };

  const startSession = (session) => {
    const code = generateCode();
    setCurrentCode(code);
    setQrDataUrl(generateQRCode(code));
    setTimeRemaining(settings.codeRefreshInterval * 60);
    
    const updatedSession = {
      ...session,
      status: 'active',
      startTime: Date.now(),
      code: code
    };
    
    setSessions(sessions.map(s => s.id === session.id ? updatedSession : s));
    setCurrentSession(updatedSession);
    setInstructorView('dashboard');
  };

  const endSession = () => {
    if (currentSession) {
      setSessions(sessions.map(s => 
        s.id === currentSession.id ? {...s, status: 'completed', endTime: Date.now()} : s
      ));
    }
    setCurrentSession(null);
    setCurrentCode('');
    setQrDataUrl('');
    setTimeRemaining(0);
  };

  const cancelSession = (sessionId) => {
    if (window.confirm('Cancel this session?')) {
      setSessions(sessions.map(s => 
        s.id === sessionId ? {...s, status: 'cancelled'} : s
      ));
    }
  };

  const deleteSession = (sessionId) => {
    if (window.confirm('Delete this session and all attendance records?')) {
      setSessions(sessions.filter(s => s.id !== sessionId));
      setAttendance(attendance.filter(a => a.sessionId !== sessionId));
    }
  };

  const markExcused = (attendanceId) => {
    setAttendance(attendance.map(a => 
      a.id === attendanceId ? {...a, status: 'Excused'} : a
    ));
  };

  useEffect(() => {
    if (!currentSession) return;
    const timer = setInterval(() => {
      setTimeRemaining(prev => {
        if (prev <= 1) {
          const newCode = generateCode();
          setCurrentCode(newCode);
          setQrDataUrl(generateQRCode(newCode));
          return settings.codeRefreshInterval * 60;
        }
        return prev - 1;
      });
    }, 1000);
    return () => clearInterval(timer);
  }, [currentSession, settings.codeRefreshInterval]);

  const getAttendanceStatus = () => {
    if (!currentSession || !currentSession.startTime) return 'Absent';
    const minutesElapsed = (Date.now() - currentSession.startTime) / 1000 / 60;
    if (minutesElapsed <= settings.presentUntil) return 'Present';
    if (minutesElapsed <= settings.tardyUntil) return 'Tardy';
    return 'Absent';
  };

  const handleCheckIn = () => {
    if (!currentSession) {
      setCheckInMessage('No active session');
      return;
    }
    if (!studentName.trim()) {
      setCheckInMessage('Please enter your name');
      return;
    }
    if (studentCode !== currentCode) {
      setCheckInMessage('Invalid code. Please try again.');
      return;
    }
    const alreadyCheckedIn = attendance.find(
      a => a.sessionId === currentSession.id && a.name.toLowerCase() === studentName.toLowerCase()
    );
    if (alreadyCheckedIn) {
      setCheckInMessage('You have already checked in!');
      return;
    }
    const status = getAttendanceStatus();
    const newAttendance = {
      id: Date.now(),
      sessionId: currentSession.id,
      classId: currentSession.classId,
      className: currentSession.className,
      sessionName: currentSession.name,
      name: studentName,
      status: status,
      time: new Date().toLocaleTimeString(),
      date: new Date().toLocaleDateString(),
      timestamp: Date.now()
    };
    setAttendance([...attendance, newAttendance]);
    setCheckInMessage(`✓ Checked in as ${status}`);
    setStudentName('');
    setStudentCode('');
    setTimeout(() => setCheckInMessage(''), 3000);
  };

  const exportToCSV = (classId = null) => {
    const recordsToExport = classId ? attendance.filter(a => a.classId === classId) : attendance;
    if (recordsToExport.length === 0) {
      alert('No attendance records to export!');
      return;
    }
    const headers = ['Date', 'Class', 'Session', 'Student Name', 'Status', 'Check-in Time'];
    const rows = recordsToExport.map(record => [
      record.date, record.className, record.sessionName, record.name, record.status, record.time
    ]);
    let csvContent = headers.join(',') + '\n';
    rows.forEach(row => {
      csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `attendance_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const getSessionAttendance = (sessionId) => {
    return attendance.filter(a => a.sessionId === sessionId);
  };

  const getClassSessions = (classId) => {
    return sessions.filter(s => s.classId === classId);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-4">College Attendance Tracker</h1>
          <div className="flex gap-2">
            <button onClick={() => setView('instructor')} className={`px-6 py-2 rounded-lg font-medium ${view === 'instructor' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}>Instructor</button>
            <button onClick={() => setView('student')} className={`px-6 py-2 rounded-lg font-medium ${view === 'student' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}>Student</button>
          </div>
        </div>

        {view === 'instructor' && !instructorAuthenticated && (
          <div className="bg-white rounded-lg shadow-lg p-8 max-w-md mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Instructor Access</h2>
            <div className="space-y-4">
              <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleInstructorLogin()} placeholder="Enter instructor password" className="w-full px-4 py-3 border border-gray-300 rounded-lg" />
              <button onClick={handleInstructorLogin} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-medium">Login</button>
              {loginError && <div className="p-3 bg-red-100 text-red-800 rounded-lg text-center text-sm">{loginError}</div>}
              <p className="text-xs text-gray-500 text-center">Default password: instructor123</p>
            </div>
          </div>
        )}

        {view === 'instructor' && instructorAuthenticated && (
          <>
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex gap-2 overflow-x-auto">
                <button onClick={() => setInstructorView('dashboard')} className={`px-4 py-2 rounded-lg whitespace-nowrap ${instructorView === 'dashboard' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}>Dashboard</button>
                <button onClick={() => setInstructorView('classes')} className={`px-4 py-2 rounded-lg whitespace-nowrap ${instructorView === 'classes' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}>Classes</button>
                <button onClick={() => setInstructorView('sessions')} className={`px-4 py-2 rounded-lg whitespace-nowrap ${instructorView === 'sessions' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}>Sessions</button>
                <button onClick={() => setInstructorView('settings')} className={`px-4 py-2 rounded-lg whitespace-nowrap ${instructorView === 'settings' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}>Settings</button>
              </div>
            </div>

            {instructorView === 'dashboard' && currentSession && (
              <div className="space-y-6">
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h2 className="text-xl font-bold">{currentSession.className}</h2>
                      <p className="text-gray-600">{currentSession.name}</p>
                    </div>
                    <button onClick={endSession} className="px-6 py-2 bg-red-600 text-white rounded-lg">End Session</button>
                  </div>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="text-center bg-gray-50 p-6 rounded-lg">
                      <QrCode className="w-6 h-6 mx-auto mb-2 text-indigo-600" />
                      <h3 className="font-semibold mb-4">QR Code</h3>
                      {qrDataUrl && <img src={qrDataUrl} alt="QR" className="mx-auto border-4 border-white shadow-lg" />}
                    </div>
                    <div className="text-center bg-gray-50 p-6 rounded-lg flex flex-col justify-center">
                      <Hash className="w-6 h-6 mx-auto mb-2 text-indigo-600" />
                      <h3 className="font-semibold mb-4">Manual Code</h3>
                      <div className="text-5xl font-bold text-indigo-600 mb-4">{currentCode}</div>
                      <div className="flex items-center justify-center gap-2 text-gray-600">
                        <Clock className="w-4 h-4" />
                        <span>Refreshes in: {formatTime(timeRemaining)}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h3 className="text-lg font-bold mb-4">Attendance ({getSessionAttendance(currentSession.id).length})</h3>
                  {getSessionAttendance(currentSession.id).length === 0 ? (
                    <p className="text-gray-500 text-center py-4">No check-ins yet</p>
                  ) : (
                    <table className="w-full">
                      <thead>
                        <tr className="border-b">
                          <th className="text-left py-3 px-4">Student</th>
                          <th className="text-left py-3 px-4">Status</th>
                          <th className="text-left py-3 px-4">Time</th>
                          <th className="text-left py-3 px-4">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {getSessionAttendance(currentSession.id).map(r => (
                          <tr key={r.id} className="border-b">
                            <td className="py-3 px-4">{r.name}</td>
                            <td className="py-3 px-4">
                              <span className={`px-3 py-1 rounded-full text-sm ${
                                r.status === 'Present' ? 'bg-green-100 text-green-800' :
                                r.status === 'Tardy' ? 'bg-yellow-100 text-yellow-800' :
                                r.status === 'Excused' ? 'bg-blue-100 text-blue-800' :
                                'bg-red-100 text-red-800'
                              }`}>{r.status}</span>
                            </td>
                            <td className="py-3 px-4">{r.time}</td>
                            <td className="py-3 px-4">
                              {r.status !== 'Excused' && (
                                <button onClick={() => markExcused(r.id)} className="text-blue-600 text-sm">Mark Excused</button>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              </div>
            )}

            {instructorView === 'dashboard' && !currentSession && (
              <div className="bg-white rounded-lg shadow-lg p-8 text-center">
                <Calendar className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h3 className="text-xl font-bold mb-2">No Active Session</h3>
                <p className="text-gray-600 mb-6">Go to Sessions to start tracking</p>
                <button onClick={() => setInstructorView('sessions')} className="px-6 py-3 bg-indigo-600 text-white rounded-lg">View Sessions</button>
              </div>
            )}

            {instructorView === 'classes' && (
              <div className="space-y-6">
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4">Add New Class</h2>
                  <div className="flex gap-2">
                    <input value={newClassName} onChange={(e) => setNewClassName(e.target.value)} placeholder="Class name" className="flex-1 px-4 py-2 border rounded-lg" />
                    <button onClick={addClass} className="px-6 py-2 bg-indigo-600 text-white rounded-lg flex items-center gap-2">
                      <Plus className="w-4 h-4" />Add
                    </button>
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4">Your Classes</h2>
                  {classes.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">No classes yet</p>
                  ) : (
                    <div className="grid md:grid-cols-2 gap-4">
                      {classes.map(c => (
                        <div key={c.id} className="border rounded-lg p-4">
                          <div className="flex justify-between mb-2">
                            <h3 className="font-bold">{c.name}</h3>
                            <button onClick={() => deleteClass(c.id)} className="text-red-600"><Trash2 className="w-4 h-4" /></button>
                          </div>
                          <p className="text-sm text-gray-600 mb-2">{getClassSessions(c.id).length} sessions</p>
                          <button onClick={() => exportToCSV(c.id)} className="text-sm text-indigo-600 flex items-center gap-1">
                            <Download className="w-3 h-3" />Export
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {instructorView === 'sessions' && (
              <div className="space-y-6">
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4">Schedule Session</h2>
                  <div className="space-y-4">
                    <select value={selectedClass?.id || ''} onChange={(e) => setSelectedClass(classes.find(c => c.id === parseInt(e.target.value)))} className="w-full px-4 py-2 border rounded-lg">
                      <option value="">Choose class...</option>
                      {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </select>
                    <div className="grid md:grid-cols-3 gap-4">
                      <input type="date" value={newSessionDate} onChange={(e) => setNewSessionDate(e.target.value)} className="px-4 py-2 border rounded-lg" />
                      <input type="time" value={newSessionTime} onChange={(e) => setNewSessionTime(e.target.value)} className="px-4 py-2 border rounded-lg" />
                      <input value={newSessionName} onChange={(e) => setNewSessionName(e.target.value)} placeholder="Session name" className="px-4 py-2 border rounded-lg" />
                    </div>
                    <button onClick={addSession} className="px-6 py-2 bg-indigo-600 text-white rounded-lg flex items-center gap-2">
                      <Plus className="w-4 h-4" />Schedule
                    </button>
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4">All Sessions</h2>
                  {sessions.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">No sessions scheduled</p>
                  ) : (
                    <div className="space-y-4">
                      {sessions.map(s => (
                        <div key={s.id} className="border rounded-lg p-4">
                          <div className="flex justify-between">
                            <div>
                              <h3 className="font-bold">{s.className}</h3>
                              <p className="text-sm text-gray-600">{s.name}</p>
                              <p className="text-sm text-gray-500">{new Date(s.date).toLocaleDateString()} at {s.time}</p>
                              <span className={`inline-block mt-2 px-3 py-1 rounded-full text-xs ${
                                s.status === 'active' ? 'bg-green-100 text-green-800' :
                                s.status === 'completed' ? 'bg-gray-100 text-gray-800' :
                                s.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                'bg-blue-100 text-blue-800'
                              }`}>{s.status}</span>
                            </div>
                            <div className="flex flex-col gap-2">
                              {s.status === 'scheduled' && <button onClick={() => startSession(s)} className="px-4 py-2 bg-green-600 text-white rounded text-sm">Start</button>}
                              {s.status === 'scheduled' && <button onClick={() => cancelSession(s.id)} className="px-4 py-2 bg-yellow-600 text-white rounded text-sm">Cancel</button>}
                              <button onClick={() => deleteSession(s.id)} className="px-4 py-2 bg-red-600 text-white rounded text-sm">Delete</button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {instructorView === 'settings' && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4">Time Settings</h2>
                <div className="grid md:grid-cols-3 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium mb-2">Present Window (min)</label>
                    <input type="number" value={settings.presentUntil} onChange={(e) => setSettings({...settings, presentUntil: parseInt(e.target.value) || 0})} className="w-full px-3 py-2 border rounded-lg" min="1" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Tardy Window (min)</label>
                    <input type="number" value={settings.tardyUntil} onChange={(e) => setSettings({...settings, tardyUntil: parseInt(e.target.value) || 0})} className="w-full px-3 py-2 border rounded-lg" min="1" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Code Refresh (min)</label>
                    <input type="number" value={settings.codeRefreshInterval} onChange={(e) => setSettings({...settings, codeRefreshInterval: parseInt(e.target.value) || 1})} className="w-full px-3 py-2 border rounded-lg" min="1" />
                  </div>
                </div>
                <button onClick={() => exportToCSV()} className="px-6 py-2 bg-green-600 text-white rounded-lg flex items-center gap-2">
                  <Download className="w-4 h-4" />Export All Data
                </button>
              </div>
            )}
          </>
        )}

        {view === 'student' && (
          <div className="bg-white rounded-lg shadow-lg p-8 max-w-md mx-auto">
            <h2 className="text-2xl font-bold mb-6 text-center">Student Check-In</h2>
            {!currentSession ? (
              <p className="text-gray-500 text-center py-8">No active session. Wait for instructor to start.</p>
            ) : (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Your Name</label>
                  <input value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="Full name" className="w-full px-4 py-3 border rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Attendance Code</label>
                  <input value={studentCode} onChange={(e) => setStudentCode(e.target.value)} placeholder="6-digit code" maxLength={6} className="w-full px-4 py-3 border rounded-lg text-2xl text-center tracking-widest font-mono" />
                </div>
                <button onClick={handleCheckIn} className="w-full py-3 bg-indigo-600 text-white rounded-lg">Check In</button>
                {checkInMessage && (
                  <div className={`p-4 rounded-lg text-center ${checkInMessage.includes('✓') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{checkInMessage}</div>
                )}
                <div className="p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-center">
                    <strong>Status Windows:</strong><br />
                    Present: Within {settings.presentUntil} min<br />
                    Tardy: {settings.presentUntil + 1}-{settings.tardyUntil} min<br />
                    Absent: After {settings.tardyUntil} min
                  </p>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default AttendanceTracker;
