import React, { useState, useEffect } from 'react';
import { Calendar, Users, Clock, BarChart3, Settings, FileDown, Mail, CheckCircle, AlertCircle, UserCheck, MapPin, QrCode, Smartphone, Edit, Plus, Trash2, Upload, X } from 'lucide-react';

export default function ProAttendanceSystem() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [currentTime, setCurrentTime] = useState(new Date());
  const [attendanceMode, setAttendanceMode] = useState('manual');
  const [showQRCode, setShowQRCode] = useState(false);
  const [qrCodeData, setQrCodeData] = useState('');
  const [nfcListening, setNfcListening] = useState(false);
  const [checkInLog, setCheckInLog] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [editingStudent, setEditingStudent] = useState(null);
  const [showAddClass, setShowAddClass] = useState(false);
  const [showAddStudent, setShowAddStudent] = useState(false);
  const [showAddSession, setShowAddSession] = useState(false);
  const [selectedClass, setSelectedClass] = useState(null);
  const [selectedSession, setSelectedSession] = useState(null);
  
  const [classes, setClasses] = useState([
    { id: 1, name: 'Computer Science 101', code: 'CS101', instructor: 'Dr. Smith', schedule: 'MWF 9:00-10:00' },
    { id: 2, name: 'Mathematics 201', code: 'MATH201', instructor: 'Prof. Johnson', schedule: 'TTh 11:00-12:30' }
  ]);

  const [sessions, setSessions] = useState([
    { id: 1, classId: 1, date: '2024-11-22', startTime: '09:00', endTime: '10:00', status: 'scheduled', location: 'Room 101' },
    { id: 2, classId: 1, date: '2024-11-24', startTime: '09:00', endTime: '10:00', status: 'scheduled', location: 'Room 101' },
    { id: 3, classId: 2, date: '2024-11-23', startTime: '11:00', endTime: '12:30', status: 'scheduled', location: 'Room 205' }
  ]);

  const [students, setStudents] = useState([
    { id: 1, classId: 1, name: 'John Doe', studentId: 'STU001', email: 'john@example.com', photo: 'ðŸ‘¨â€ðŸŽ“' },
    { id: 2, classId: 1, name: 'Jane Smith', studentId: 'STU002', email: 'jane@example.com', photo: 'ðŸ‘©â€ðŸŽ“' },
    { id: 3, classId: 1, name: 'Bob Johnson', studentId: 'STU003', email: 'bob@example.com', photo: 'ðŸ‘¨â€ðŸ’¼' },
    { id: 4, classId: 2, name: 'Alice Williams', studentId: 'STU004', email: 'alice@example.com', photo: 'ðŸ‘©â€ðŸ’»' },
    { id: 5, classId: 2, name: 'Charlie Brown', studentId: 'STU005', email: 'charlie@example.com', photo: 'ðŸ‘¨â€ðŸŽ¨' }
  ]);

  const [attendance, setAttendance] = useState([
    { id: 1, sessionId: 1, studentId: 1, status: 'Present', checkInTime: '09:05', location: 'In-Person' },
    { id: 2, sessionId: 1, studentId: 2, status: 'Present', checkInTime: '09:03', location: 'Remote' },
    { id: 3, sessionId: 1, studentId: 3, status: 'Absent', checkInTime: '-', location: '-' }
  ]);

  const [newClass, setNewClass] = useState({ name: '', code: '', instructor: '', schedule: '' });
  const [newStudent, setNewStudent] = useState({ name: '', studentId: '', email: '' });
  const [newSession, setNewSession] = useState({ date: '', startTime: '', endTime: '', location: '' });
  const [alertSettings, setAlertSettings] = useState({ emailInstructors: true, triggerThreshold: true, scheduledReports: true, absenceThreshold: 3 });

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    if (classes.length > 0 && !selectedClass) {
      setSelectedClass(classes[0]);
    }
  }, [classes]);

  const generateQRCode = (data) => {
    const size = 200;
    const qrData = encodeURIComponent(data);
    return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${qrData}`;
  };

  const addLog = (event, type) => {
    setCheckInLog(prev => [...prev, { timestamp: new Date().toLocaleString(), event, type }]);
  };

  const handleAddClass = () => {
    if (!newClass.name || !newClass.code) return alert('Please enter class name and code');
    const newClassObj = { ...newClass, id: classes.length + 1 };
    setClasses([...classes, newClassObj]);
    setNewClass({ name: '', code: '', instructor: '', schedule: '' });
    setShowAddClass(false);
    addLog(`Added class: ${newClass.name}`, 'class');
  };

  const handleDeleteClass = (classId) => {
    if (!confirm('Delete this class and all related data?')) return;
    setClasses(classes.filter(c => c.id !== classId));
    setStudents(students.filter(s => s.classId !== classId));
    setSessions(sessions.filter(s => s.classId !== classId));
    addLog(`Deleted class`, 'class');
  };

  const handleAddStudent = () => {
    if (!newStudent.name || !newStudent.studentId) return alert('Please enter student name and ID');
    if (!selectedClass) return alert('Please select a class first');
    const studentObj = { ...newStudent, id: students.length + 1, classId: selectedClass.id, photo: 'ðŸ‘¤' };
    setStudents([...students, studentObj]);
    setNewStudent({ name: '', studentId: '', email: '' });
    setShowAddStudent(false);
    addLog(`Added student: ${newStudent.name}`, 'student');
  };

  const handleUploadClassList = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target.result;
      const lines = text.split('\n');
      const newStudents = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const [name, studentId, email] = line.split(',').map(s => s.trim());
        if (name && studentId) {
          newStudents.push({
            id: students.length + newStudents.length + 1,
            classId: selectedClass.id,
            name,
            studentId,
            email: email || '',
            photo: 'ðŸ‘¤'
          });
        }
      }
      
      setStudents([...students, ...newStudents]);
      addLog(`Uploaded ${newStudents.length} students`, 'upload');
      alert(`Successfully uploaded ${newStudents.length} students`);
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const handleDeleteStudent = (studentId) => {
    if (!confirm('Delete this student?')) return;
    setStudents(students.filter(s => s.id !== studentId));
    setAttendance(attendance.filter(a => a.studentId !== studentId));
    addLog(`Deleted student`, 'student');
  };

  const handleAddSession = () => {
    if (!newSession.date || !newSession.startTime || !newSession.endTime) return alert('Please fill all session fields');
    if (!selectedClass) return alert('Please select a class first');
    const sessionObj = {
      ...newSession,
      id: sessions.length + 1,
      classId: selectedClass.id,
      status: 'scheduled'
    };
    setSessions([...sessions, sessionObj]);
    setNewSession({ date: '', startTime: '', endTime: '', location: '' });
    setShowAddSession(false);
    addLog(`Added session for ${newSession.date}`, 'session');
  };

  const handleDeleteSession = (sessionId) => {
    if (!confirm('Delete this session?')) return;
    setSessions(sessions.filter(s => s.id !== sessionId));
    setAttendance(attendance.filter(a => a.sessionId !== sessionId));
    addLog(`Deleted session`, 'session');
  };

  const handleStartSession = (session) => {
    setSelectedSession(session);
    setSessions(sessions.map(s => s.id === session.id ? { ...s, status: 'active' } : s));
    addLog(`Started session for ${session.date}`, 'session');
  };

  const handleEndSession = () => {
    if (!selectedSession) return;
    setSessions(sessions.map(s => s.id === selectedSession.id ? { ...s, status: 'completed' } : s));
    addLog(`Ended session`, 'session');
    setSelectedSession(null);
    setShowQRCode(false);
  };

  const handleStatusChange = (studentId, newStatus, sessionId) => {
    const existingAttendance = attendance.find(a => a.sessionId === sessionId && a.studentId === studentId);
    const student = students.find(s => s.id === studentId);
    
    if (existingAttendance) {
      setAttendance(attendance.map(a => 
        a.sessionId === sessionId && a.studentId === studentId
          ? { ...a, status: newStatus, checkInTime: newStatus !== 'Absent' ? new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-' }
          : a
      ));
    } else {
      setAttendance([...attendance, {
        id: attendance.length + 1,
        sessionId,
        studentId,
        status: newStatus,
        checkInTime: newStatus !== 'Absent' ? new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-',
        location: 'In-Person'
      }]);
    }
    
    addLog(`${student?.name || 'Student'} marked as ${newStatus}`, 'status');
  };

  const handleQRCheckIn = () => {
    if (!selectedSession) return alert('Please start a session first');
    const qrData = `SESSION:${selectedSession.id}:${Date.now()}`;
    setQrCodeData(qrData);
    setShowQRCode(true);
    addLog('QR Code generated', 'qr');
  };

  const simulateQRScan = () => {
    if (!selectedSession) return;
    const classStudents = students.filter(s => s.classId === selectedClass.id);
    const randomStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
    handleStatusChange(randomStudent.id, 'Present', selectedSession.id);
    addLog(`${randomStudent.name} checked in via QR`, 'checkin');
  };

  const handleNFCCheckIn = () => {
    if (!selectedSession) return alert('Please start a session first');
    setNfcListening(true);
    addLog('NFC reader activated', 'nfc');
    setTimeout(() => {
      const classStudents = students.filter(s => s.classId === selectedClass.id);
      const randomStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
      handleStatusChange(randomStudent.id, 'Present', selectedSession.id);
      addLog(`${randomStudent.name} checked in via NFC`, 'checkin');
      setNfcListening(false);
    }, 2000);
  };

  const handleExportCSV = () => {
    if (!selectedClass || !selectedSession) return alert('Select a class and session');
    const classStudents = students.filter(s => s.classId === selectedClass.id);
    const headers = ['Student Name', 'Student ID', 'Email', 'Status', 'Check-In Time'];
    const rows = classStudents.map(s => {
      const att = attendance.find(a => a.sessionId === selectedSession.id && a.studentId === s.id);
      return [s.name, s.studentId, s.email, att?.status || 'Not Marked', att?.checkInTime || '-'];
    });
    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_${selectedClass.code}_${selectedSession.date}.csv`;
    a.click();
    addLog('Exported CSV', 'export');
  };

  const getAttendanceStats = () => {
    if (!selectedClass || !selectedSession) return { total: 0, present: 0, absent: 0, rate: 0 };
    const classStudents = students.filter(s => s.classId === selectedClass.id);
    const sessionAttendance = attendance.filter(a => a.sessionId === selectedSession.id);
    const present = sessionAttendance.filter(a => a.status === 'Present' || a.status === 'Late').length;
    const absent = sessionAttendance.filter(a => a.status === 'Absent').length;
    const total = classStudents.length;
    const rate = total > 0 ? Math.round((present / total) * 100) : 0;
    return { total, present, absent, rate };
  };

  const getStudentAttendanceRecord = (studentId) => {
    const studentAttendance = attendance.filter(a => a.studentId === studentId);
    const absences = studentAttendance.filter(a => a.status === 'Absent').length;
    return absences;
  };

  const stats = getAttendanceStats();
  const classStudents = selectedClass ? students.filter(s => s.classId === selectedClass.id) : [];
  const classSessions = selectedClass ? sessions.filter(s => s.classId === selectedClass.id) : [];
  
  const filteredStudents = classStudents.filter(s => 
    s.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
    s.studentId.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4 flex-wrap gap-4">
            <div>
              <h1 className="text-4xl font-bold text-white mb-2 flex items-center gap-3">
                <CheckCircle className="text-cyan-400" size={40} />
                Attendance Management System
              </h1>
              <p className="text-gray-400">Multi-class attendance tracking and reporting</p>
            </div>
            <div className="bg-gradient-to-r from-cyan-500 to-blue-600 px-6 py-3 rounded-xl">
              <p className="text-white font-bold">{classes.length} Classes</p>
              <p className="text-cyan-100 text-sm">{students.length} Students Total</p>
            </div>
          </div>

          <div className="flex gap-3 flex-wrap">
            {[
              { id: 'dashboard', icon: BarChart3, label: 'Dashboard' },
              { id: 'classes', icon: Users, label: 'Classes' },
              { id: 'sessions', icon: Calendar, label: 'Sessions' },
              { id: 'checkin', icon: UserCheck, label: 'Check-In' },
              { id: 'reports', icon: BarChart3, label: 'Reports' },
              { id: 'settings', icon: Settings, label: 'Settings' }
            ].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-4 py-3 rounded-lg transition-all ${activeTab === tab.id ? 'bg-cyan-500 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>
                <tab.icon size={20} />
                <span className="font-medium">{tab.label}</span>
              </button>
            ))}
          </div>
        </div>

        <div className="bg-gray-900 rounded-2xl p-8 shadow-2xl">
          {activeTab === 'dashboard' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold text-white">Dashboard</h2>
                <div className="flex items-center gap-2 bg-gray-700 px-4 py-2 rounded-lg">
                  <Clock size={20} className="text-cyan-400" />
                  <span className="text-white font-mono">{currentTime.toLocaleTimeString()}</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-6 rounded-xl">
                  <Users className="text-white mb-2" size={32} />
                  <h3 className="text-white text-4xl font-bold">{classes.length}</h3>
                  <p className="text-cyan-100">Total Classes</p>
                </div>
                <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-6 rounded-xl">
                  <CheckCircle className="text-white mb-2" size={32} />
                  <h3 className="text-white text-4xl font-bold">{students.length}</h3>
                  <p className="text-green-100">Total Students</p>
                </div>
                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-xl">
                  <Calendar className="text-white mb-2" size={32} />
                  <h3 className="text-white text-4xl font-bold">{sessions.length}</h3>
                  <p className="text-purple-100">Total Sessions</p>
                </div>
                <div className="bg-gradient-to-br from-orange-500 to-red-600 p-6 rounded-xl">
                  <AlertCircle className="text-white mb-2" size={32} />
                  <h3 className="text-white text-4xl font-bold">{sessions.filter(s => s.status === 'active').length}</h3>
                  <p className="text-orange-100">Active Sessions</p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Recent Classes</h3>
                  <div className="space-y-3">
                    {classes.slice(0, 5).map(cls => (
                      <div key={cls.id} className="bg-gray-700 p-3 rounded-lg">
                        <p className="text-white font-medium">{cls.name}</p>
                        <p className="text-gray-400 text-sm">{cls.code} - {cls.instructor}</p>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Recent Activity</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {checkInLog.slice(-8).reverse().map((log, idx) => (
                      <div key={idx} className="text-sm bg-gray-700 p-2 rounded">
                        <span className="text-gray-400 text-xs">{log.timestamp}</span>
                        <p className="text-white">{log.event}</p>
                      </div>
                    ))}
                    {checkInLog.length === 0 && <p className="text-gray-400 text-center py-4">No activity yet</p>}
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'classes' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold text-white">Classes</h2>
                <button onClick={() => setShowAddClass(true)} className="flex items-center gap-2 bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg">
                  <Plus size={18} />
                  Add Class
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {classes.map(cls => (
                  <div key={cls.id} className="bg-gray-800 p-6 rounded-xl border-2 border-gray-700 hover:border-cyan-500 transition-all">
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <h3 className="text-xl font-bold text-white">{cls.name}</h3>
                        <p className="text-gray-400">{cls.code}</p>
                      </div>
                      <button onClick={() => handleDeleteClass(cls.id)} className="text-red-400 hover:text-red-300">
                        <Trash2 size={18} />
                      </button>
                    </div>
                    <div className="space-y-2">
                      <p className="text-gray-300"><span className="text-gray-500">Instructor:</span> {cls.instructor}</p>
                      <p className="text-gray-300"><span className="text-gray-500">Schedule:</span> {cls.schedule}</p>
                      <p className="text-gray-300"><span className="text-gray-500">Students:</span> {students.filter(s => s.classId === cls.id).length}</p>
                      <p className="text-gray-300"><span className="text-gray-500">Sessions:</span> {sessions.filter(s => s.classId === cls.id).length}</p>
                    </div>
                    <button onClick={() => { setSelectedClass(cls); setActiveTab('sessions'); }}
                      className="w-full mt-4 bg-cyan-500 hover:bg-cyan-600 text-white py-2 rounded-lg">
                      View Details
                    </button>
                  </div>
                ))}
              </div>

              {showAddClass && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                  <div className="bg-gray-800 p-6 rounded-xl w-96">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-white">Add New Class</h3>
                      <button onClick={() => setShowAddClass(false)} className="text-gray-400 hover:text-white">
                        <X size={24} />
                      </button>
                    </div>
                    <div className="space-y-3">
                      <input type="text" placeholder="Class Name" value={newClass.name}
                        onChange={(e) => setNewClass({...newClass, name: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="text" placeholder="Class Code (e.g., CS101)" value={newClass.code}
                        onChange={(e) => setNewClass({...newClass, code: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="text" placeholder="Instructor Name" value={newClass.instructor}
                        onChange={(e) => setNewClass({...newClass, instructor: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="text" placeholder="Schedule (e.g., MWF 9:00-10:00)" value={newClass.schedule}
                        onChange={(e) => setNewClass({...newClass, schedule: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <button onClick={handleAddClass} className="w-full bg-cyan-500 hover:bg-cyan-600 text-white py-2 rounded-lg">Add Class</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'sessions' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-3xl font-bold text-white">Sessions</h2>
                  {selectedClass && <p className="text-gray-400">{selectedClass.name}</p>}
                </div>
                <div className="flex gap-2">
                  <select value={selectedClass?.id || ''} onChange={(e) => setSelectedClass(classes.find(c => c.id === parseInt(e.target.value)))}
                    className="bg-gray-700 text-white px-4 py-2 rounded-lg">
                    {classes.map(cls => (
                      <option key={cls.id} value={cls.id}>{cls.name}</option>
                    ))}
                  </select>
                  <button onClick={() => setShowAddSession(true)} disabled={!selectedClass}
                    className="flex items-center gap-2 bg-cyan-500 hover:bg-cyan-600 disabled:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    <Plus size={18} />
                    Add Session
                  </button>
                </div>
              </div>

              {selectedClass && (
                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Manage Students</h3>
                  <div className="flex gap-2 mb-4">
                    <button onClick={() => setShowAddStudent(true)} className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                      <Plus size={18} />
                      Add Student
                    </button>
                    <label className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg cursor-pointer">
                      <Upload size={18} />
                      Upload CSV
                      <input type="file" accept=".csv" onChange={handleUploadClassList} className="hidden" />
                    </label>
                  </div>
                  <p className="text-gray-400 text-sm mb-4">CSV format: Name, Student ID, Email (one per line, header row required)</p>
                  <div className="space-y-2">
                    {classStudents.map(student => (
                      <div key={student.id} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">{student.photo}</span>
                          <div>
                            <p className="text-white font-medium">{student.name}</p>
                            <p className="text-gray-400 text-sm">{student.studentId} - {student.email}</p>
                          </div>
                        </div>
                        <button onClick={() => handleDeleteStudent(student.id)} className="text-red-400 hover:text-red-300">
                          <Trash2 size={18} />
                        </button>
                      </div>
                    ))}
                    {classStudents.length === 0 && <p className="text-gray-400 text-center py-4">No students in this class</p>}
                  </div>
                </div>
              )}

              <div className="space-y-3">
                {classSessions.map(session => (
                  <div key={session.id} className="bg-gray-800 p-4 rounded-xl flex items-center justify-between">
                    <div>
                      <p className="text-white font-bold">{session.date}</p>
                      <p className="text-gray-400">{session.startTime} - {session.endTime}</p>
                      <p className="text-gray-400 text-sm">{session.location}</p>
                      <span className={`inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${
                        session.status === 'active' ? 'bg-green-500/20 text-green-400' :
                        session.status === 'completed' ? 'bg-blue-500/20 text-blue-400' :
                        'bg-gray-500/20 text-gray-400'
                      }`}>{session.status}</span>
                    </div>
                    <div className="flex gap-2">
                      {session.status === 'scheduled' && (
                        <button onClick={() => handleStartSession(session)} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                          Start Session
                        </button>
                      )}
                      {session.status === 'active' && (
                        <button onClick={() => { setSelectedSession(session); setActiveTab('checkin'); }} className="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg">
                          Take Attendance
                        </button>
                      )}
                      <button onClick={() => handleDeleteSession(session.id)} className="text-red-400 hover:text-red-300">
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </div>
                ))}
                {classSessions.length === 0 && <p className="text-gray-400 text-center py-8">No sessions scheduled. Click "Add Session" to create one.</p>}
              </div>

              {showAddSession && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                  <div className="bg-gray-800 p-6 rounded-xl w-96">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-white">Add New Session</h3>
                      <button onClick={() => setShowAddSession(false)} className="text-gray-400 hover:text-white">
                        <X size={24} />
                      </button>
                    </div>
                    <div className="space-y-3">
                      <input type="date" value={newSession.date}
                        onChange={(e) => setNewSession({...newSession, date: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="time" placeholder="Start Time" value={newSession.startTime}
                        onChange={(e) => setNewSession({...newSession, startTime: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="time" placeholder="End Time" value={newSession.endTime}
                        onChange={(e) => setNewSession({...newSession, endTime: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="text" placeholder="Location (e.g., Room 101)" value={newSession.location}
                        onChange={(e) => setNewSession({...newSession, location: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <button onClick={handleAddSession} className="w-full bg-cyan-500 hover:bg-cyan-600 text-white py-2 rounded-lg">Add Session</button>
                    </div>
                  </div>
                </div>
              )}

              {showAddStudent && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                  <div className="bg-gray-800 p-6 rounded-xl w-96">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-white">Add Student</h3>
                      <button onClick={() => setShowAddStudent(false)} className="text-gray-400 hover:text-white">
                        <X size={24} />
                      </button>
                    </div>
                    <div className="space-y-3">
                      <input type="text" placeholder="Student Name" value={newStudent.name}
                        onChange={(e) => setNewStudent({...newStudent, name: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="text" placeholder="Student ID" value={newStudent.studentId}
                        onChange={(e) => setNewStudent({...newStudent, studentId: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <input type="email" placeholder="Email" value={newStudent.email}
                        onChange={(e) => setNewStudent({...newStudent, email: e.target.value})}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600" />
                      <button onClick={handleAddStudent} className="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">Add Student</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'checkin' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-3xl font-bold text-white">Student Check-In</h2>
                  {selectedSession && selectedClass && (
                    <p className="text-gray-400">{selectedClass.name} - {selectedSession.date}</p>
                  )}
                </div>
                {selectedSession && (
                  <button onClick={handleEndSession} className="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold">
                    End Session
                  </button>
                )}
              </div>

              {!selectedSession ? (
                <div className="text-center py-12">
                  <AlertCircle size={64} className="text-gray-600 mx-auto mb-4" />
                  <p className="text-gray-400 text-lg">No active session. Please start a session from the Sessions tab.</p>
                  <button onClick={() => setActiveTab('sessions')} className="mt-4 bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg">
                    Go to Sessions
                  </button>
                </div>
              ) : (
                <>
                  <div className="bg-gray-800 p-6 rounded-xl">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="text-center">
                        <p className="text-4xl font-bold text-cyan-400">{stats.total}</p>
                        <p className="text-gray-400">Total Students</p>
                      </div>
                      <div className="text-center">
                        <p className="text-4xl font-bold text-green-400">{stats.present}</p>
                        <p className="text-gray-400">Present</p>
                      </div>
                      <div className="text-center">
                        <p className="text-4xl font-bold text-red-400">{stats.absent}</p>
                        <p className="text-gray-400">Absent</p>
                      </div>
                      <div className="text-center">
                        <p className="text-4xl font-bold text-purple-400">{stats.rate}%</p>
                        <p className="text-gray-400">Attendance Rate</p>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {[
                      { mode: 'qr', icon: QrCode, label: 'QR Code', color: 'cyan' },
                      { mode: 'nfc', icon: Smartphone, label: 'NFC', color: 'purple' },
                      { mode: 'manual', icon: UserCheck, label: 'Manual', color: 'green' }
                    ].map(({ mode, icon: Icon, label, color }) => (
                      <button key={mode} onClick={() => setAttendanceMode(mode)}
                        className={`p-6 rounded-xl border-2 transition-all ${attendanceMode === mode ? `border-${color}-500 bg-${color}-500/10` : 'border-gray-700 bg-gray-800 hover:border-gray-600'}`}>
                        <Icon size={48} className={`text-${color}-400 mb-3 mx-auto`} />
                        <h3 className="text-white font-bold text-lg">{label}</h3>
                      </button>
                    ))}
                  </div>

                  <div className="bg-gray-800 p-6 rounded-xl">
                    {attendanceMode === 'qr' && (
                      <div className="text-center py-8">
                        {!showQRCode ? (
                          <button onClick={handleQRCheckIn} className="px-8 py-4 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-bold">
                            Generate QR Code
                          </button>
                        ) : (
                          <div>
                            <div className="inline-block p-4 bg-white rounded-xl mb-4">
                              <img src={generateQRCode(qrCodeData)} alt="QR Code" className="w-64 h-64" />
                            </div>
                            <p className="text-gray-400 mb-2">Students scan this QR code to check in</p>
                            <p className="text-cyan-400 text-sm mb-4">Session: {selectedSession.date}</p>
                            <div className="flex gap-3 justify-center">
                              <button onClick={simulateQRScan} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                                Simulate Scan
                              </button>
                              <button onClick={() => setShowQRCode(false)} className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                                Close
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {attendanceMode === 'nfc' && (
                      <div className="text-center py-8">
                        <Smartphone size={120} className={`mx-auto mb-4 ${nfcListening ? 'text-purple-400 animate-pulse' : 'text-gray-600'}`} />
                        <h4 className="text-white text-xl font-bold mb-2">{nfcListening ? 'Listening for NFC tap...' : 'NFC Reader Standby'}</h4>
                        <p className="text-gray-400 mb-4">Students tap their ID card on the reader</p>
                        <button onClick={handleNFCCheckIn} disabled={nfcListening}
                          className="px-8 py-4 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-600 text-white rounded-lg font-bold">
                          {nfcListening ? 'Waiting for tap...' : 'Activate NFC Reader'}
                        </button>
                      </div>
                    )}

                    {attendanceMode === 'manual' && (
                      <div className="space-y-3">
                        {classStudents.map((student) => {
                          const studentAttendance = attendance.find(a => a.sessionId === selectedSession.id && a.studentId === student.id);
                          return (
                            <div key={student.id} className="flex items-center justify-between bg-gray-700 p-4 rounded-lg">
                              <div className="flex items-center gap-3">
                                <span className="text-3xl">{student.photo}</span>
                                <div>
                                  <p className="text-white font-medium">{student.name}</p>
                                  <p className="text-gray-400 text-sm">{student.studentId}</p>
                                </div>
                                {studentAttendance && (
                                  <span className={`ml-4 px-3 py-1 rounded-full text-sm font-semibold ${
                                    studentAttendance.status === 'Present' ? 'bg-green-500/20 text-green-400' :
                                    studentAttendance.status === 'Absent' ? 'bg-red-500/20 text-red-400' :
                                    'bg-yellow-500/20 text-yellow-400'
                                  }`}>{studentAttendance.status}</span>
                                )}
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => handleStatusChange(student.id, 'Present', selectedSession.id)} 
                                  className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">Present</button>
                                <button onClick={() => handleStatusChange(student.id, 'Absent', selectedSession.id)}
                                  className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">Absent</button>
                                <button onClick={() => handleStatusChange(student.id, 'Late', selectedSession.id)}
                                  className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">Late</button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>
          )}

          {activeTab === 'reports' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold text-white">Reports</h2>
                <button onClick={handleExportCSV} disabled={!selectedSession}
                  className="flex items-center gap-2 bg-cyan-500 hover:bg-cyan-600 disabled:bg-gray-600 text-white px-4 py-2 rounded-lg">
                  <FileDown size={18} />
                  Export Current Session
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Select Class & Session</h3>
                  <div className="space-y-3">
                    <select value={selectedClass?.id || ''} onChange={(e) => setSelectedClass(classes.find(c => c.id === parseInt(e.target.value)))}
                      className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600">
                      <option value="">Select a class</option>
                      {classes.map(cls => (
                        <option key={cls.id} value={cls.id}>{cls.name}</option>
                      ))}
                    </select>
                    {selectedClass && (
                      <select value={selectedSession?.id || ''} onChange={(e) => setSelectedSession(sessions.find(s => s.id === parseInt(e.target.value)))}
                        className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600">
                        <option value="">Select a session</option>
                        {classSessions.map(session => (
                          <option key={session.id} value={session.id}>{session.date} - {session.startTime}</option>
                        ))}
                      </select>
                    )}
                  </div>
                </div>

                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Session Statistics</h3>
                  {selectedSession ? (
                    <div className="space-y-2">
                      <div className="flex justify-between">
                        <span className="text-gray-400">Total Students:</span>
                        <span className="text-white font-bold">{stats.total}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">Present:</span>
                        <span className="text-green-400 font-bold">{stats.present}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">Absent:</span>
                        <span className="text-red-400 font-bold">{stats.absent}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">Not Marked:</span>
                        <span className="text-gray-400 font-bold">{stats.total - stats.present - stats.absent}</span>
                      </div>
                      <div className="flex justify-between pt-2 border-t border-gray-700">
                        <span className="text-gray-400">Attendance Rate:</span>
                        <span className="text-cyan-400 font-bold text-xl">{stats.rate}%</span>
                      </div>
                    </div>
                  ) : (
                    <p className="text-gray-400 text-center py-4">Select a session to view statistics</p>
                  )}
                </div>
              </div>

              {selectedSession && (
                <div className="bg-gray-800 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-white mb-4">Attendance Details</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-gray-700">
                          <th className="text-left text-cyan-400 py-3 px-4">Student</th>
                          <th className="text-left text-cyan-400 py-3 px-4">ID</th>
                          <th className="text-left text-cyan-400 py-3 px-4">Status</th>
                          <th className="text-left text-cyan-400 py-3 px-4">Check-In Time</th>
                          <th className="text-left text-cyan-400 py-3 px-4">Total Absences</th>
                        </tr>
                      </thead>
                      <tbody>
                        {classStudents.map((student) => {
                          const att = attendance.find(a => a.sessionId === selectedSession.id && a.studentId === student.id);
                          const absences = getStudentAttendanceRecord(student.id);
                          return (
                            <tr key={student.id} className="border-b border-gray-700">
                              <td className="py-3 px-4 text-white">{student.name}</td>
                              <td className="py-3 px-4 text-gray-300">{student.studentId}</td>
                              <td className="py-3 px-4">
                                {att ? (
                                  <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                    att.status === 'Present' ? 'bg-green-500/20 text-green-400' :
                                    att.status === 'Absent' ? 'bg-red-500/20 text-red-400' :
                                    'bg-yellow-500/20 text-yellow-400'
                                  }`}>{att.status}</span>
                                ) : (
                                  <span className="text-gray-400">Not Marked</span>
                                )}
                              </td>
                              <td className="py-3 px-4 text-gray-300">{att?.checkInTime || '-'}</td>
                              <td className="py-3 px-4">
                                <span className={`font-bold ${absences >= alertSettings.absenceThreshold ? 'text-red-400' : 'text-gray-300'}`}>
                                  {absences}
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'settings' && (
            <div className="space-y-6">
              <h2 className="text-3xl font-bold text-white">Settings</h2>

              <div className="bg-gray-800 p-6 rounded-xl">
                <h3 className="text-xl font-bold text-white mb-4">Alert Configuration</h3>
                <div className="space-y-3">
                  {[
                    { key: 'emailInstructors', label: 'Email instructors on absence' },
                    { key: 'triggerThreshold', label: 'Trigger alerts after threshold' },
                    { key: 'scheduledReports', label: 'Send scheduled reports' }
                  ].map(({ key, label }) => (
                    <label key={key} className="flex items-center gap-3 text-white cursor-pointer">
                      <input type="checkbox" checked={alertSettings[key]} 
                        onChange={(e) => setAlertSettings({...alertSettings, [key]: e.target.checked})} className="w-5 h-5" />
                      <span>{label}</span>
                    </label>
                  ))}
                  <div className="pt-2">
                    <label className="text-gray-400 text-sm">Absence Threshold</label>
                    <input type="number" value={alertSettings.absenceThreshold}
                      onChange={(e) => setAlertSettings({...alertSettings, absenceThreshold: parseInt(e.target.value) || 3})}
                      className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 mt-1" />
                  </div>
                </div>
              </div>

              <div className="bg-gray-800 p-6 rounded-xl">
                <h3 className="text-xl font-bold text-white mb-4">System Information</h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Classes:</span>
                    <span className="text-white font-bold">{classes.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Students:</span>
                    <span className="text-white font-bold">{students.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Sessions:</span>
                    <span className="text-white font-bold">{sessions.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Attendance Records:</span>
                    <span className="text-white font-bold">{attendance.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Activity Logs:</span>
                    <span className="text-white font-bold">{checkInLog.length}</span>
                  </div>
                </div>
              </div>

              <div className="bg-gray-800 p-6 rounded-xl">
                <h3 className="text-xl font-bold text-white mb-4">Active Features</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {[
                    'Multi-Class Management',
                    'Session Scheduling',
                    'CSV Student Import',
                    'Manual Student Entry',
                    'QR Code Check-In',
                    'NFC Check-In',
                    'Manual Attendance',
                    'Real-time Statistics',
                    'CSV Export',
                    'Activity Logging',
                    'Alert System',
                    'Data Persistence'
                  ].map((feature, idx) => (
                    <div key={idx} className="flex items-center gap-2 bg-gray-700 p-3 rounded-lg">
                      <CheckCircle size={16} className="text-green-400" />
                      <span className="text-white text-sm">{feature}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
